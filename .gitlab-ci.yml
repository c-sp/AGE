image: registry.gitlab.com/csprenger/docker-age-ci:latest

stages:
    - build
    - test



############################################################
##
##   artifacts
##
############################################################

# Build artifacts are ignored by git (as they are part of .gitignore).
# Unfortunately because of that they cannot be used as GitLab CI artifacts.
#
# The current (non-invasive) solution is to temporarily move build artifacts
# to another directory after job execution in order to pass them to other stages
# and move them back to their original position for job execution.

variables:
    ARTIFACTS: build/artifacts
    CI_ARTIFACTS: build/ci_artifacts

.artifacts-common: &artifacts-common
    before_script:
        - rm -rf "${ARTIFACTS}"
        - (if [ -d "${CI_ARTIFACTS}" ]; then mv "${CI_ARTIFACTS}" "${ARTIFACTS}"; fi);
    after_script:
        - rm -rf "${CI_ARTIFACTS}"
        - (if [ -d "${ARTIFACTS}" ]; then mv "${ARTIFACTS}" "${CI_ARTIFACTS}"; fi);
    artifacts:
        expire_in: 30 mins
        paths:
            - ${CI_ARTIFACTS}
    tags:
        - linux


# All age-js jobs are configured to cache the node_modules.
# Jobs of each branch use the same cache (see cache key).
#
# The GitLab.com shared runners use distributed caches:
# https://docs.gitlab.com/ee/ci/caching/#good-caching-practices

.age-js-common: &age-js-common
    image: registry.gitlab.com/csprenger/docker-age-ci/js:latest
    cache:
        key: ${CI_COMMIT_REF_SLUG}
        paths:
            - src/age_js/node_modules
    tags:
        - linux



############################################################
##
##   build
##
############################################################

.build-qt: &build-qt
    stage: build
    <<: *artifacts-common
    script:
        - ./build/age_ci.sh qt ${BUILD_TYPE}

build-qt-debug:
    <<: *build-qt
    variables:
        BUILD_TYPE: debug

build-qt-release:
    <<: *build-qt
    variables:
        BUILD_TYPE: release


build-wasm:
    stage: build
    <<: *artifacts-common
    image: registry.gitlab.com/csprenger/docker-age-ci/wasm:latest
    script:
        - source "${REPO_EMSDK}/emsdk_env.sh"
        - ./build/age_ci.sh wasm Release

build-age-js:
    stage: build
    <<: *artifacts-common
    <<: *age-js-common
    script:
        - build/age_ci.sh js build



############################################################
##
##   test
##
############################################################

.test-common: &test-common
    stage: test
    <<: *artifacts-common

.test-release: &test-release
    <<: *test-common
    dependencies:
        - build-qt-release

.test-debug: &test-debug
    <<: *test-common
    dependencies:
        - build-qt-debug

.tests-mooneye: &tests-mooneye
    script:
        - ./build/age_ci.sh test mooneye "${GB_REPO_MOONEYE_GB}/tests/build"

.tests-gambatte: &tests-gambatte
    script:
        - ./build/age_ci.sh test gambatte "${GB_REPO_GAMBATTE}/test/hwtests"


test-mooneye-release:
    <<: *test-release
    <<: *tests-mooneye

test-mooneye-debug:
    <<: *test-debug
    <<: *tests-mooneye

test-gambatte-release:
    <<: *test-release
    <<: *tests-gambatte

# gambatte tests run for longer than 10 minutes with the debug build
#test-gambatte-debug:
#    <<: *test-debug
#    <<: *tests-gambatte


lint-age-js:
    stage: test
    <<: *age-js-common
    script:
        - build/age_ci.sh js lint
